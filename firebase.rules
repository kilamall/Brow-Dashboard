rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    function isAdmin() {
      return request.auth != null && request.auth.token.role == 'admin';
    }

    match /settings/{doc} {
      allow read: if true;
      allow write: if isAdmin();
    }

    match /services/{id} {
      allow read: if true;
      allow write, delete, create: if isAdmin();
    }

    match /customers/{id} {
      // SECURED: Require auth for customer creation
      allow read: if isAdmin() || 
        (request.auth != null && 
         (request.auth.token.email == resource.data.email ||
          request.auth.token.phone_number == resource.data.phone));
      
      // Allow authenticated creation only
      allow create: if request.auth != null;
      
      allow update: if isAdmin() || 
        (request.auth != null && 
         (request.auth.token.email == resource.data.email ||
          request.auth.token.phone_number == resource.data.phone));
      allow delete: if isAdmin();
    }

    match /appointments/{id} {
      // SECURED: Only admins and appointment owners can read
      // Availability is now in separate collection
      allow read: if isAdmin() || 
        (request.auth != null && request.auth.uid == resource.data.customerId);
      
      // SECURED: Creation only via Cloud Functions
      allow create: if false; // Cloud Functions only
      
      allow update: if isAdmin() || 
        (request.auth != null && 
         resource.data.customerId != null &&
         request.resource.data.status == 'cancelled');
      allow delete: if isAdmin();
    }

    match /availability/{id} {
      // PUBLIC: Read-only for booking availability
      // Contains only time slots, no customer data
      allow read: if true;
      
      // SECURED: Write only via Cloud Functions or triggers
      allow write: if false; // Cloud Functions use Admin SDK (bypasses rules)
    }

    match /holds/{id} {
      // SECURED: Read for availability, write via Cloud Functions ONLY
      allow read: if true;
      allow write: if false;  // Cloud Functions use Admin SDK (bypasses rules)
      allow delete: if false;
    }

    match /messages/{id} {
      allow read: if isAdmin() || 
        (request.auth != null && 
         request.auth.uid == resource.data.customerId);
      allow create: if request.auth != null &&
        request.resource.data.content is string &&
        request.resource.data.type in ['customer', 'admin'] &&
        request.resource.data.customerName is string &&
        request.resource.data.customerEmail is string &&
        request.resource.data.customerId is string;
      allow update: if isAdmin();
    }

    match /reviews/{id} {
      allow read: if true;
      allow create: if request.auth != null;
      allow update: if isAdmin();
      allow delete: if isAdmin();
    }

    match /conversations/{id} {
      allow read: if isAdmin() || 
        (request.auth != null && 
         request.auth.uid == resource.data.customerId);
      allow create: if request.auth != null && 
        request.resource.data.customerId is string &&
        request.resource.data.customerName is string;
      allow update: if isAdmin() || 
        (request.auth != null && 
         request.auth.uid == resource.data.customerId);
    }

    match /customer_tokens/{id} {
      allow read, write: if isAdmin() || 
        (request.auth != null && 
         request.auth.uid == resource.data.customerId);
      allow create: if request.resource.data.customerId is string &&
        request.resource.data.token is string;
    }

    match /sms_conversations/{id} {
      allow read: if isAdmin();
      allow create: if request.auth != null;
    }

    match /sms_logs/{id} {
      allow read, write: if isAdmin();
    }

    match /ai_conversations/{id} {
      allow read: if isAdmin() || 
        (request.auth != null && 
         request.auth.uid == resource.data.customerId);
      allow create: if request.auth != null;
      allow update: if isAdmin();
    }

    match /ai_sms_conversations/{id} {
      allow read: if isAdmin() || 
        (request.auth != null && 
         request.auth.uid == resource.data.customerId);
      allow create: if request.auth != null;
      allow update: if isAdmin();
    }

    match /email_subscriptions/{id} {
      allow read: if isAdmin();
      allow create: if true;
      allow update, delete: if isAdmin();
    }

    match /sms_consents/{id} {
      allow read: if isAdmin();
      allow create: if true;
      allow update, delete: if isAdmin();
    }

    match /skinAnalyses/{id} {
      allow read: if isAdmin() || 
        (request.auth != null && 
         request.auth.uid == resource.data.customerId);
      allow create: if request.auth != null && 
        request.resource.data.customerId == request.auth.uid;
      allow update: if isAdmin() || 
        (request.auth != null && 
         request.auth.uid == resource.data.customerId);
      allow delete: if isAdmin();
    }

    match /skinAnalysisRequests/{id} {
      allow read: if isAdmin() || 
        (request.auth != null && 
         request.auth.uid == resource.data.customerId);
      allow create: if request.auth != null && 
        request.resource.data.customerId == request.auth.uid;
      allow update: if isAdmin();
      allow delete: if isAdmin();
    }

    match /ai_analysis_cache/{id} {
      allow read, write: if false; // Only Cloud Functions can access cache
    }

    match /appointmentEditRequests/{id} {
      allow read: if isAdmin() || 
        (request.auth != null && 
         request.auth.uid == resource.data.customerId);
      allow create: if request.auth != null && 
        request.resource.data.customerId is string &&
        request.resource.data.appointmentId is string &&
        request.resource.data.requestedChanges is map;
      allow update: if isAdmin();
    }

    // Consent Form Templates - Only admins can manage templates
    match /consentFormTemplates/{id} {
      allow read: if true; // Public read so customers can view consent forms during booking
      allow create, update, delete: if isAdmin();
    }

    // Customer Consent Records
    match /customerConsents/{id} {
      // Admins can read all consents
      // Customers can read their own consents
      allow read: if isAdmin() || 
        (request.auth != null && 
         request.auth.uid == resource.data.customerId);
      
      // Allow both authenticated users and guests to create consent records
      // This is necessary for the booking flow to work for all users
      allow create: if request.auth != null || 
        (request.resource.data.customerName is string &&
         request.resource.data.consentFormId is string &&
         request.resource.data.agreed == true);
      
      // Only admins can update or delete consent records (immutable audit trail)
      allow update, delete: if isAdmin();
    }
  }
}